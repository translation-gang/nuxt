---
title: 'Управление состоянием'
description: Nuxt предоставляет композабл useState и интеграции с библиотеками управления состоянием для реактивного и SSR-совместимого общего состояния.
navigation.icon: i-lucide-database
---

В Nuxt композабл [`useState`](/docs/4.x/api/composables/use-state) создаёт реактивное общее состояние, совместимое с SSR.

[`useState`](/docs/4.x/api/composables/use-state) — замена [`ref`](https://vuejs.org/api/reactivity-core#ref) с учётом SSR: значение сохраняется после серверного рендеринга (при гидрации на клиенте) и разделяется между компонентами по уникальному ключу.

:video-accordion{title="Видео Alexander Lichter: зачем и когда использовать useState" videoId="mv0WcBABcIk"}

::important
Данные в [`useState`](/docs/4.x/api/composables/use-state) сериализуются в JSON, поэтому не должны содержать классы, функции или символы.
::

::read-more{to="/docs/4.x/api/composables/use-state"}
Подробнее о композабле `useState`.
::

## Рекомендации

::warning
Не объявляйте `const state = ref()` вне `<script setup>` или функции `setup()`. Например, `export myState = ref({})` приведёт к общему состоянию между запросами на сервере и утечкам памяти.
::

::tip{icon="i-lucide-circle-check"}
Используйте паттерн `const useX = () => useState('x')`
::

## Примеры

### Базовое использование

Локальный счётчик: любой компонент, вызывающий `useState('counter')`, разделяет то же реактивное состояние.

```vue twoslash [app/app.vue]
<script setup lang="ts">
const counter = useState('counter', () => Math.round(Math.random() * 1000))
</script>

<template>
  <div>
    Counter: {{ counter }}
    <button @click="counter++">
      +
    </button>
    <button @click="counter--">
      -
    </button>
  </div>
</template>
```

:link-example{to="/docs/4.x/examples/features/state-management"}

::note
Для глобальной инвалидации кэша состояния см. утилиту [`clearNuxtState`](/docs/4.x/api/utils/clear-nuxt-state).
::

### Инициализация состояния

Часто состояние нужно заполнить асинхронными данными. Используйте компонент [`app.vue`](/docs/4.x/directory-structure/app/app) и утилиту [`callOnce`](/docs/4.x/api/utils/call-once):

```vue twoslash [app/app.vue]
<script setup lang="ts">
const websiteConfig = useState('config')

await callOnce(async () => {
  websiteConfig.value = await $fetch('https://my-cms.com/api/website-config')
})
</script>
```

::tip
Похоже на [экшен `nuxtServerInit`](https://v2.nuxt.com/docs/directory-structure/store/#the-nuxtserverinit-action) в Nuxt 2: заполнение начального состояния на сервере перед рендером.
::

:read-more{to="/docs/4.x/api/utils/call-once"}

### Использование с Pinia

Пример с [модулем Pinia](/modules/pinia) для глобального store:

::important
Установите модуль: `npx nuxt module add pinia` или по [инструкции модуля](https://pinia.vuejs.org/ssr/nuxt.html#Installation).
::

::code-group
```ts [app/stores/website.ts]
export const useWebsiteStore = defineStore('websiteStore', {
  state: () => ({
    name: '',
    description: '',
  }),
  actions: {
    async fetch () {
      const infos = await $fetch('https://api.nuxt.com/modules/pinia')

      this.name = infos.name
      this.description = infos.description
    },
  },
})
```
```vue [app/app.vue]
<script setup lang="ts">
const website = useWebsiteStore()

await callOnce(website.fetch)
</script>

<template>
  <main>
    <h1>{{ website.name }}</h1>
    <p>{{ website.description }}</p>
  </main>
</template>
```
::

## Продвинутое использование

::code-group
```ts [app/composables/locale.ts]
import type { Ref } from 'vue'

export const useLocale = () => {
  return useState<string>('locale', () => useDefaultLocale().value)
}

export const useDefaultLocale = (fallback = 'en-US') => {
  const locale = ref(fallback)
  if (import.meta.server) {
    const reqLocale = useRequestHeaders()['accept-language']?.split(',')[0]
    if (reqLocale) {
      locale.value = reqLocale
    }
  } else if (import.meta.client) {
    const navLang = navigator.language
    if (navLang) {
      locale.value = navLang
    }
  }
  return locale
}

export const useLocales = () => {
  const locale = useLocale()
  const locales = ref([
    'en-US',
    'en-GB',
    // ...,
    'ja-JP-u-ca-japanese',
  ])
  if (!locales.value.includes(locale.value)) {
    locales.value.unshift(locale.value)
  }
  return locales
}

export const useLocaleDate = (date: Ref<Date> | Date, locale = useLocale()) => {
  return computed(() => new Intl.DateTimeFormat(locale.value, { dateStyle: 'full' }).format(unref(date)))
}
```

```vue [app/app.vue]
<script setup lang="ts">
const locales = useLocales()
const locale = useLocale()
const date = useLocaleDate(new Date('2016-10-26'))
</script>

<template>
  <div>
    <h1>Nuxt birthday</h1>
    <p>{{ date }}</p>
    <label for="locale-chooser">Выберите другую локаль</label>
    <select
      id="locale-chooser"
      v-model="locale"
    >
      <option
        v-for="loc of locales"
        :key="loc"
        :value="loc"
      >
        {{ loc }}
      </option>
    </select>
  </div>
</template>
```
::

:link-example{to="/docs/4.x/examples/advanced/locale"}

## Общее состояние

С [автоимпортом композаблов](/docs/4.x/directory-structure/app/composables) можно задавать глобальные типизированные состояния и использовать их по всему приложению.

```ts twoslash [composables/states.ts]
export const useColor = () => useState<string>('color', () => 'pink')
```

```vue [app/app.vue]
<script setup lang="ts">
// ---cut-start---
const useColor = () => useState<string>('color', () => 'pink')
// ---cut-end---
const color = useColor() // То же, что useState('color')
</script>

<template>
  <p>Current color: {{ color }}</p>
</template>
```

:video-accordion{title="Видео Daniel Roe: глобальное состояние и SSR в Nuxt" videoId="dZSNW07sO-A"}

## Сторонние библиотеки

Раньше Nuxt использовал Vuex для глобального состояния. При миграции с Nuxt 2 см. [руководство по миграции](/docs/4.x/migration/configuration#vuex).

Nuxt не навязывает решение для состояния; можно выбрать любое. Есть интеграции с популярными библиотеками:

- [Pinia](/modules/pinia) — официальная рекомендация Vue
- [Harlem](/modules/harlem) — иммутабельное глобальное состояние
- [XState](/modules/xstate) — конечные автоматы с визуализацией и тестами
